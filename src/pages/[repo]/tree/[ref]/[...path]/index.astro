---
import {getRepoTreesStaticPaths} from 'astro-git/gitStaticPaths.js';
import {getRepo} from 'astro-git/git.js';
import BaseLayout from '@layout/BaseLayout.astro';
import RepoHeader from '@components/RepoHeader.astro'
import GitTree from '@components/GitTree.astro';
import GitFile from '@components/GitFile.astro';
import GitPathNotFound from '@components/GitPathNotFound.astro';

let {repo: repoName, ref, path} = {...Astro.props, ...Astro.params};
const repo = getRepo(repoName);

const {refPathMap, pathMap, oidMap} = await repo.getStaticHelpers();

path = oidMap.get(path) || path;
let entry = refPathMap?.get(ref)?.get(path);
if(entry == null){
	entry = {
		type: "not_found",
		options: Array.from(pathMap.get(path)?.keys() || [])
	}
}

const View = entry.type === "tree" ? GitTree : entry.type === "blob" ? GitFile : GitPathNotFound;

export const getStaticPaths = async () => await getRepoTreesStaticPaths();

---
<BaseLayout>
  <RepoHeader repo={repo} ref={ref} path={path}/>
  <View repo={repo} ref={ref} path={path} entry={entry}/>
</BaseLayout>
